name: Build Docker Image

on:
    push:

jobs:
    buildx:
        runs-on: ubuntu-latest
        env:
            DATABASE_URL: "mysql://root:root@127.0.0.1/sylius"
        steps:
            -
                name: Checkout
                uses: actions/checkout@v2
            -
                name: Set up Docker Buildx
                id: buildx
                uses: docker/setup-buildx-action@v1
            -
                name: Build Docker Image
                run: |
                    docker build .docker --tag sylius
            -
                name: Check Versions
                run: |
                    chmod +x .docker/run-tests.sh
                    ./.docker/run-tests.sh
            -
                name: Shutdown default MySQL
                run: sudo service mysql stop
            -
                name: Setup MySQL
                uses: mirromutth/mysql-action@v1.1
                with:
                    mysql version: "5.7"
                    mysql root password: "root"
            -
                name: Run PHPUnit
                run: |
                    docker run \
                    -v "$(pwd)"/:/app:delegated \
                    -v "$(pwd)"/.docker/test/php.ini:/etc/php/8.0/fpm/php.ini:delegated \
                    -v "$(pwd)"/.docker/test/php.ini:/etc/php/8.0/cli/php.ini:delegated \
                    -e DATABASE_URL=$DATABASE_URL \
                    -i sylius make ci
